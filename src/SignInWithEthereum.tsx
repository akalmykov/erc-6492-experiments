import React, { useCallback, useEffect, useMemo, useState } from "react";
import { useAccount, usePublicClient, useSignMessage } from "wagmi";
import { SiweMessage } from "siwe";
import type { Hex } from "viem";

export function SignInWithEthereum() {
  const [signature, setSignature] = useState<Hex | undefined>(undefined);
  const { signMessage } = useSignMessage({
    mutation: { onSuccess: (sig) => setSignature(sig) },
  });
  const account = useAccount();
  const [valid, setValid] = useState<boolean | undefined>(undefined);
  const [backendValid, setBackendValid] = useState<boolean | undefined>(
    undefined
  );
  const client = usePublicClient();

  const siweMessage = useMemo(() => {
    // return new SiweMessage("Hello, world!");
    if (!account.address) {
      return new SiweMessage({});
    }
    const siweMsg = new SiweMessage({
      domain: document.location.host,
      address: account.address,
      chainId: account.chainId,
      uri: document.location.origin,
      version: "1",
      statement: "Smart Wallet SIWE Example",
      nonce: "12345678", // replace with nonce generated by your backend
    });
    console.log("domain", siweMsg.domain);
    console.log("address", siweMsg.address);
    console.log("chainId", siweMsg.chainId);
    console.log("uri", siweMsg.uri);
    console.log("version", siweMsg.version);
    console.log("statement", siweMsg.statement);
    console.log("nonce", siweMsg.nonce);
    console.log("siweMsg.toMessage", siweMsg.toMessage());
    console.log("siweMsg.prepareMessage", siweMsg.prepareMessage());
    return siweMsg;
  }, []);

  const promptToSign = () => {
    signMessage({ message: siweMessage.prepareMessage() });
  };

  const checkValid = useCallback(async () => {
    if (!signature || !account.address || !client) return;
    console.log("verifying this", siweMessage.prepareMessage());
    const isValid = await client.verifyMessage({
      address: account.address,
      message: siweMessage.prepareMessage(),
      signature,
    });
    console.log("signature", signature);
    console.log("isValid", isValid);
    console.log("address", account.address);

    // Call backend verification API
    const backendVerifyResponse = await fetch(
      "https://bph3yyq8q4.execute-api.us-east-1.amazonaws.com/prod/verify",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          chainId: siweMessage.chainId,
          address: siweMessage.address,
          nonce: siweMessage.nonce,
          issuedAt: siweMessage.issuedAt,
          domain: siweMessage.domain,
          uri: siweMessage.uri,
          version: siweMessage.version,
          statement: siweMessage.statement,
          signature: signature,
        }),
      }
    );

    const backendVerifyResult = await backendVerifyResponse.json();
    console.log("Backend verification result:", backendVerifyResult.success);
    setBackendValid(backendVerifyResult.success);
    setValid(isValid);
  }, [signature, account]);

  useEffect(() => {
    checkValid();
  }, [signature, account]);

  return (
    <div>
      <h2>SIWE Example</h2>
      <button onClick={promptToSign}>Sign In with Ethereum</button>
      {signature && <p>Signature: {signature}</p>}
      {valid !== undefined && <p>Local check is valid: {valid.toString()}</p>}
      {backendValid !== undefined && (
        <p>Backend check is valid: {backendValid.toString()}</p>
      )}
    </div>
  );
}
